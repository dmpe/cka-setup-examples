# cka-setup-examples

[Exam Examples &amp; Setup](https://gist.github.com/bakavets/05681473ca617579156de033ba40ee7a#certified-kubernetes-administrator-cka)

Some other information:
- https://docs.linuxfoundation.org/tc-docs/certification/important-instructions-cks
- Need to know 
  - https://aquasecurity.github.io/trivy/v0.49/
- https://github.com/kodekloudhub/certified-kubernetes-security-specialist-cks-course
- https://devopscube.com/cks-exam-guide-tips/
- https://www.freecodecamp.org/news/how-to-pass-the-certified-kubernetes-security-specialist-exam/#aliases

## Exam

- 10% Cluster Setup
  - NetPolicies
  - CIS benchmark
  - Ingress control
  - Verify binaries
- 15% Cluster hardening
  - RBACs
- 15% System Hardening
  - OS footprint
  - least privilage
  - AppArmor, seccomp
- 20% Minimize vulnerabilities
  - k8s secrets
  - pod-to-pod mTLS
  - OS level security
- 20% Supply chain security
  - base image footprint
  - image registry, sign and validate images
  - Scan with Trivy
- 20% Observability
  - Audit logs
  - immutability of runtimes
  - behavioral analytics/threat detection

## Minikube setup

```
./bin/calico.sh
sudo -E minikube start
```

## Setup Kubectl

```
export EDITOR=nano
echo 'source <(kubectl completion bash)' >>~/.bashrc
echo 'alias k=kubectl' >>~/.bashrc
echo 'complete -o default -F __start_kubectl k' >>~/.bashrc
```

## Setting Namespace with context

```
k config get-contexts
k config set-context minikube --namespace kube-system
```

# Cluster Setup
## Network Policies

- no imperative way, only declarative
- NS based approach

## CIS Benchmark

- Execute as job

```
kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/\
main/job-master.yaml
```

## TLS Ingress

- Create TLS cert, sign and import 

```
openssl req -nodes -new -x509 -keyout x.key -out x.crt -subj "/CN=x.tls"
kubectl create secret tls x --cert=x.crt --key=x.key
```
- adjust ingress object with `spec.tls`

```
spec:
  tls:
  - secretName: x
    hosts:
    - a.com
  rules:
    ...
```


- to test locally, find node IP, add to `/etc/hosts` file and then do `curl`

## Protect inbound K8s ports

- use firewall
- protect cloud metadata endpoints -> Network Policies
- protect GUI such as k8s dashboard with oauth2 proxy

## Verify binaries

- https://dl.k8s.io lists all hashes
- `$(cat kubectl.sha256) kubectl | sha256sum --check` for checking it


# Cluster hardening

## Kubernetes API Server

- AuthN -> AuthZ -> Admission Controller -> Validation
- AC verifies if request is well-formed or needs to be modified.
- Validation optional, can be in AC.
- API Server is exposed: 
  - kubernetes.default.svc to avoid IP for API server, e.g. from inside pod
    - its endpoint points to the IP/port
  - e.g. in pod via env variables `KUBERNETES_SERVICE_HOST` and `_PORT`
- access with client cert
- from kubeconfig extract base64 encoded values and then execute
```
curl --cacert ca --cert kubernetes-admin.crt --key kubernetes-admin.key ...
```

### Restricting Access

- do not expose public k8s API server
- limit permissions via RBAC
- add new users

  - crete private key `openssl genrsa -out johndoe.key 2048`
  - create and approve CertSignReq 
    ```
    openssl req -new -key johndoe.key -out johndoe.csr
    cat johndoe.csr | base64 | tr -d "\n"
    cat <<EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: johndoe
spec:
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tL...
  signerName: kubernetes.io/kube-apiserver-client
  expirationSeconds: 86400
  usages:
  - client auth
EOF
  kubectl certificate approve johndoe
  kubectl get csr johndoe -o jsonpath={.status.certificate} | base64 -d > johndoe.crt
    ```
  - add Role and assign Role to RB with the user
  - add to kubeconfig
  ```
  kubectl config set-credentials johndoe --client-key=johndoe.key \
--client-certificate=johndoe.crt --embed-certs=true
  kubectl config set-context johndoe --cluster=minikube --user=johndoe
  ```

- SA -> disable automount token in the pod
- SA token can be generated by `create token` or via k8s secret with special type and annotation
- Update K8s frequently